(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{124:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return b}));var o=n(2),a=n(6),r=(n(0),n(146)),i={id:"cloud-foundry",title:"Deploying as a Cloud Foundry Application",sidebar_label:"Deploy on Cloud Foundry"},l={id:"deploy/cloud-foundry/cloud-foundry",isDocsHomePage:!1,title:"Deploying as a Cloud Foundry Application",description:"Deployment Steps",source:"@site/docs/deploy/cloud-foundry/cloud-foundry.md",permalink:"/docs/deploy/cloud-foundry/cloud-foundry",editUrl:"https://github.com/cloudfoundry/stratos/edit/master/website/docs/deploy/cloud-foundry/cloud-foundry.md",sidebar_label:"Deploy on Cloud Foundry",sidebar:"docs",previous:{title:"Deploying Stratos",permalink:"/docs/deploy/deploy-overview"},next:{title:"Associate a Cloud Foundry database service",permalink:"/docs/deploy/cloud-foundry/db-migration"}},c=[{value:"Deployment Steps",id:"deployment-steps",children:[{value:"Running Stratos in Production Environments",id:"running-stratos-in-production-environments",children:[]},{value:"Deploy Stratos from source",id:"deploy-stratos-from-source",children:[]},{value:"Deploy Stratos from docker image",id:"deploy-stratos-from-docker-image",children:[]}]},{value:"Associate Cloud Foundry database service",id:"associate-cloud-foundry-database-service",children:[]},{value:"Use SSO Login",id:"use-sso-login",children:[{value:"Console fails to start",id:"console-fails-to-start",children:[]}]}],s={rightToc:c};function b(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(r.b)("wrapper",Object(o.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("h2",{id:"deployment-steps"},"Deployment Steps"),Object(r.b)("p",null,"Stratos can be pushed as an application to Cloud Foundry. "),Object(r.b)("p",null,"You can do it in two ways:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#deploy-stratos-from-source"}),"Deploy Stratos from source")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#deploy-stratos-from-docker-image"}),"Deploy Stratos from docker image"))),Object(r.b)("p",null,"You will then be able to open a web browser and navigate to the console URL:"),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"https://console.<DOMAIN>")),Object(r.b)("p",null,"Where ",Object(r.b)("inlineCode",{parentName:"p"},"<DOMAIN>")," is the default domain configured for your Cloud Foundry cluster."),Object(r.b)("p",null,"To login use the following credentials detailed ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"access.md"}),"here"),"."),Object(r.b)("p",null,"If you run into issues, please refer to the ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"#troubleshooting"}),"Troubleshooting Guide")," below."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"The console will pre-configure the host Cloud Foundry endpoint. No other CF instance should be registered unless the instructions in\nthe section ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"#associate-cloud-foundry-database-service"}),"Associate Cloud Foundry database service")," are followed.\nAll other deployment methods (helm, docker all-in-one, etc) allow the registration of multiple CF instances by default.")),Object(r.b)("p",null,"Note:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"You need the cf CLI command line tool installed and available on the path."),Object(r.b)("li",{parentName:"ol"},"You need to have configured the cf cli to point to your Cloud Foundry cluster, to be authenticated with your credentials and to be targeted at the organization and space where you want the console application be created."),Object(r.b)("li",{parentName:"ol"},"You may need to configure Application Security Groups on your Cloud Foundry Cluster in order that  Stratos can communicate with the Cloud Foundry API. See ",Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#application-security-groups"}),"below")," for more information."),Object(r.b)("li",{parentName:"ol"},"The Stratos Console will automatically detect the API endpoint for your Cloud Foundry. To do so, it relies on the ",Object(r.b)("inlineCode",{parentName:"li"},"cf_api_url")," value inside the ",Object(r.b)("inlineCode",{parentName:"li"},"VCAP_APPLICATION")," environment variable. If this is not provided by your Cloud Foundry platform, then you must manually update the application manifest as described ",Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#console-fails-to-start"}),"below"),".")),Object(r.b)("h3",{id:"running-stratos-in-production-environments"},"Running Stratos in Production Environments"),Object(r.b)("p",null,"Please be aware of the following when running Stratos in a production environment:"),Object(r.b)("h4",{id:"configure-a-session-store-secret"},"Configure a Session Store Secret"),Object(r.b)("p",null,"Stratos uses a Session Store Secret to protect the user session cookie. We recommend that you set your own value for this secret - choosing an alphanumeric string of your choice."),Object(r.b)("p",null,"You can configure this secret by editing the application manifest and adding to the ",Object(r.b)("inlineCode",{parentName:"p"},"env")," section, e.g."),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"applications:\n- name: console\n  ... memory, disk settings here\n  env:\n    SESSION_STORE_SECRET: <your session store secret here>\n")),Object(r.b)("h4",{id:"pre-configure-uaa-client-used-for-user-invites"},"Pre-configure UAA client used for user invites"),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"You can skip this step and configure any CFs invite clients via the Stratos UI.")),Object(r.b)("p",null," To set the UAA client for user invites, supply the client id and client secret as environment variables as shown below:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"INVITE_USER_CLIENT_ID=<UAA_CLIENT_ID>\nINVITE_USER_CLIENT_SECRET=<UAA_CLIENT_SECRET>\n")),Object(r.b)("p",null,"This will set the the UAA client and UAA secret used to invite users for the default CF only."),Object(r.b)("p",null,"See the ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"../guides/admin/invite-user-guide"}),"invite users guide")," for more information about user invites in Stratos."),Object(r.b)("h4",{id:"use-of-the-default-embedded-sqlite-database"},"Use of the Default Embedded SQLite Database"),Object(r.b)("p",null,"We do not recommend deploying Stratos to a production environment using the default embedded SQLite Database. Instead we recommend creating\nand binding a database service instance to Stratos - for more information see ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"db-migration"}),"here"),"."),Object(r.b)("h3",{id:"deploy-stratos-from-source"},"Deploy Stratos from source"),Object(r.b)("p",null,"To do so, ",Object(r.b)("inlineCode",{parentName:"p"},"clone")," the ",Object(r.b)("strong",{parentName:"p"},"stratos")," repository, ",Object(r.b)("inlineCode",{parentName:"p"},"cd")," into the newly cloned repository and ",Object(r.b)("inlineCode",{parentName:"p"},"push")," to Cloud Foundry. This can be done with:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"git clone https://github.com/cloudfoundry/stratos\ncd stratos\ngit checkout tags/stable -b stable\n./build/store-git-metadata.sh\ncf push\n")),Object(r.b)("p",null,"If the cf push exceeds the time allowed see the instructions ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"#pre-building-the-ui"}),"here")),Object(r.b)("h4",{id:"pre-building-the-ui"},"Pre-building the UI"),Object(r.b)("p",null,"Due to the memory usage of the Angular compiler (see below), when deployed to Cloud Foundry via ",Object(r.b)("inlineCode",{parentName:"p"},"cf push"),", Stratos does not use AOT (Ahead-of-Time) compilation."),Object(r.b)("p",null,"If you wish to enable AOT or reduce the push time, you can pre-build the UI before pushing."),Object(r.b)("p",null,"This can be done with:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"git clone https://github.com/cloudfoundry/stratos\ncd stratos\nnpm install\nnpm run prebuild-ui\ncf push\n")),Object(r.b)("p",null,"You will need a recent version of Node installed locally to do this."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"prebuild-ui")," npm script performs a build of the front-end UI and then zips up the resulting folder into a package named ",Object(r.b)("inlineCode",{parentName:"p"},"stratos-frontend-prebuild.zip"),". The Stratos buildpack will unpack this zip file and use its contents instead of building the UI during staging, when this file is present."),Object(r.b)("h4",{id:"memory-usage"},"Memory Usage"),Object(r.b)("p",null,"The Stratos Cloud Foundry ",Object(r.b)("inlineCode",{parentName:"p"},"manifest.yml")," states that the application requires\n",Object(r.b)("inlineCode",{parentName:"p"},"1512MB")," of memory. This is required during the build process of the\napplication since building an angular2 app is a memory intensive process. The\nmemory limit can be scaled down after the app has been pushed, using the cf CLI."),Object(r.b)("h3",{id:"deploy-stratos-from-docker-image"},"Deploy Stratos from docker image"),Object(r.b)("p",null,"Deploy Stratos using the ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://hub.docker.com/r/splatform/stratos"}),Object(r.b)("inlineCode",{parentName:"a"},"splatform/stratos"))," docker image"),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},Object(r.b)("strong",{parentName:"p"},"NOTE:")," Your Cloud Foundry must have docker support ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://docs.cloudfoundry.org/adminguide/docker.html#enable"}),"enabled"),".")),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"cf push console -o splatform/stratos:stable -m 128M -k 384M\n")),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"Note: You can replace ",Object(r.b)("inlineCode",{parentName:"p"},"console")," in the command above with a name of your choice for the application")),Object(r.b)("p",null,"Alternatively cf push using a manifest"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"download ",Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"../../../manifest-docker.yml"}),"manifest-docker.yml")," or create your own manifest file:",Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"applications:\n- name: console\n  docker:\n    image: splatform/stratos:stable\n  instances: 1\n  memory: 128M\n  disk_quota: 384M\n"))),Object(r.b)("li",{parentName:"ul"},"now, you can simply push it to Cloud Foundry:",Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"cf push -f manifest-docker.yml\n")))),Object(r.b)("h2",{id:"associate-cloud-foundry-database-service"},"Associate Cloud Foundry database service"),Object(r.b)("p",null,"Follow instructions ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"db-migration"}),"here"),"."),Object(r.b)("h2",{id:"use-sso-login"},"Use SSO Login"),Object(r.b)("p",null,"By default Stratos will present its own login UI and only supports username and password authentication with your UAA. You can configure Stratos to use UAA's login UI by specifying the  the ",Object(r.b)("inlineCode",{parentName:"p"},"SSO_LOGIN")," environment variable in the manifest, for example:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"applications:\n- name: console\n  ... memory, disk settings here\n  env:\n    SSO_LOGIN: true\n")),Object(r.b)("p",null,"When SSO Login is enabled, Stratos will also auto-connect to the Cloud Foundry it is deployed in using the token obtained during the SSO Login flow."),Object(r.b)("p",null,"For more information - see ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"../guides/admin/sso"}),"Single-Sign On"),"."),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),'[\n   {\n      "destination":"0.0.0.0-255.255.255.255",\n      "protocol":"all"\n   }\n]\n')),Object(r.b)("p",null,"Save this to a file, e.g. ",Object(r.b)("inlineCode",{parentName:"p"},"my-asg.json"),"."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"Note: this allows example all network traffic on all IP ranges - we don't recommend using this.")),Object(r.b)("p",null,"Unbind the existing ASG for you organization (",Object(r.b)("inlineCode",{parentName:"p"},"ORG"),") and space (",Object(r.b)("inlineCode",{parentName:"p"},"SPACE"),") with:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"cf unbind-security-group public_networks ORG SPACE\n")),Object(r.b)("p",null,"Create a new ASG using the definition you saved to a file and give it a name, with:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"cf create-security-group NAME my-asg.json\n")),Object(r.b)("p",null,"Bind this ASG to your ",Object(r.b)("inlineCode",{parentName:"p"},"ORG")," and ",Object(r.b)("inlineCode",{parentName:"p"},"SPACE")," with:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"cf bind-security-group NAME ORG SPACE\n")),Object(r.b)("h3",{id:"console-fails-to-start"},"Console fails to start"),Object(r.b)("p",null,"The Stratos Console will automatically detect the API endpoint for your Cloud Foundry. To do so, it relies on the ",Object(r.b)("inlineCode",{parentName:"p"},"cf_api")," value inside the ",Object(r.b)("inlineCode",{parentName:"p"},"VCAP_APPLICATION")," environment variable.\nTo check if the variable is present, use the CF CLI to list environment variables, and inspect the ",Object(r.b)("inlineCode",{parentName:"p"},"VCAP_APPLICATION")," variable under ",Object(r.b)("inlineCode",{parentName:"p"},"System-Provided"),"."),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),'$ cf env console\nGetting env variables for app console in org SUSE / space dev as admin...\nOK\n\nSystem-Provided:\n\n\n {\n  "VCAP_APPLICATION": {\n   "application_id": ...,\n   "application_name": "console",\n   "application_uris": ...\n   "application_version": ...,\n   "cf_api": "http://api.cf-dev.io",\n   ...\n }\n\n No user-defined env variables have been set\n ...\n')),Object(r.b)("p",null,"If the ",Object(r.b)("inlineCode",{parentName:"p"},"cf_api")," environment variable is absent then set the ",Object(r.b)("inlineCode",{parentName:"p"},"CF_API_URL")," variable. See the following ",Object(r.b)("em",{parentName:"p"},"Setting the ",Object(r.b)("inlineCode",{parentName:"em"},"CF_API_URL")," env variable in the manifest")," section."),Object(r.b)("p",null,"However, if the ",Object(r.b)("inlineCode",{parentName:"p"},"cf_api")," environment variable is present, and an HTTP address is specified, it is possible that insecure traffic may be blocked. See the following ",Object(r.b)("em",{parentName:"p"},"Setting the ",Object(r.b)("inlineCode",{parentName:"em"},"CF_API_FORCE_SECURE")," env variable in the manifest")," section."),Object(r.b)("h4",{id:"setting-the-cf_api_url-env-variable-in-the-manifest"},"Setting the ",Object(r.b)("inlineCode",{parentName:"h4"},"CF_API_URL")," env variable in the manifest"),Object(r.b)("p",null,"To specify the Cloud Foundry API endpoint, add the ",Object(r.b)("inlineCode",{parentName:"p"},"CF_API_URL")," variable to the manifest, for example:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"applications:\n- name: console\n  memory: 256M\n  disk_quota: 256M\n  host: console\n  timeout: 180\n  buildpack: https://github.com/cloudfoundry/stratos-buildpack\n  health-check-type: port\n  env:\n    CF_API_URL: https://<<CLOUD FOUNDRY API ENDPOINT>>>\n")),Object(r.b)("h4",{id:"setting-the-cf_api_force_secure-env-variable-in-the-manifest"},"Setting the ",Object(r.b)("inlineCode",{parentName:"h4"},"CF_API_FORCE_SECURE")," env variable in the manifest"),Object(r.b)("p",null,"To force the console to use secured communication with the Cloud Foundry API endpoint (HTTPS rather than HTTP), specify the ",Object(r.b)("inlineCode",{parentName:"p"},"CF_API_FORCE_SECURE")," environment in the manifest, for example:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{}),"applications:\n- name: console\n  memory: 256M\n  disk_quota: 256M\n  host: console\n  timeout: 180\n  buildpack: https://github.com/cloudfoundry/stratos-buildpack\n  health-check-type: port\n  env:\n    CF_API_FORCE_SECURE: true\n")))}b.isMDXComponent=!0},146:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var o=n(0),a=n.n(o);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=a.a.createContext({}),b=function(e){var t=a.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=b(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,i=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),p=b(n),d=o,m=p["".concat(i,".").concat(d)]||p[d]||u[d]||r;return n?a.a.createElement(m,l(l({ref:t},s),{},{components:n})):a.a.createElement(m,l({ref:t},s))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var s=2;s<r;s++)i[s]=n[s];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);