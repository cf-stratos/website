(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{131:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return s}));var r=n(2),a=n(6),i=(n(0),n(145)),o={title:"Backend Plugins",sidebar_label:"Backend Plugins"},l={id:"extensions/backend",isDocsHomePage:!1,title:"Backend Plugins",description:"This document provides a brief outline for extending the Stratos backend (Jetstream).",source:"@site/docs/extensions/backend.md",permalink:"/docs/extensions/backend",editUrl:"https://github.com/cloudfoundry/stratos/edit/master/website/docs/extensions/backend.md",sidebar_label:"Backend Plugins",sidebar:"docs",previous:{title:"Frontend Extensions",permalink:"/docs/extensions/frontend"}},c=[{value:"Middleware",id:"middleware",children:[]},{value:"Endpoint",id:"endpoint",children:[]},{value:"Routes",id:"routes",children:[]}],d={rightToc:c};function s(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(r.a)({},d,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"This document provides a brief outline for extending the Stratos backend (Jetstream)."),Object(i.b)("p",null,"Currently, to create an extension to the backend:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Create a folder for your plugin, in the folder ",Object(i.b)("inlineCode",{parentName:"p"},"src/jetstream/plugins"))),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Edit ",Object(i.b)("inlineCode",{parentName:"p"},"src/jetstream/load_plugins.go")," and:"),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"Add your plugin's package to the ",Object(i.b)("inlineCode",{parentName:"li"},"import")," block at the top of the file"),Object(i.b)("li",{parentName:"ul"},"Add your plugin to the list of plugins to be initialized in the ",Object(i.b)("inlineCode",{parentName:"li"},"loadPlugins")," function, e.g.")),Object(i.b)("pre",{parentName:"li"},Object(i.b)("code",Object(r.a)({parentName:"pre"},{}),' {"myplugin", myplugin.Init},\n'))),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Build Jetstream"))),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"Note: There are a few plugins in the ",Object(i.b)("inlineCode",{parentName:"p"},"src/jetstream/plugins")," folder that should help serve as examples of how to write a plugin.")),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"Note: Jetstream uses the ",Object(i.b)("a",Object(r.a)({parentName:"p"},{href:"https://echo.labstack.com/"}),"Echo web server")," from Labstack - some familiarity with this is required when developing backend plugins."),Object(i.b)("h2",Object(r.a)({parentName:"blockquote"},{id:"plugin-interface"}),"Plugin Interface")),Object(i.b)("p",null,"All plugins must implement the interface ",Object(i.b)("inlineCode",{parentName:"p"},"interfaces.StratosPlugin")," - this is defined in ",Object(i.b)("inlineCode",{parentName:"p"},"src/jetstream/repository/interfaces/plugin.go"),"."),Object(i.b)("p",null,"A plugin can implement one or all of the following plugin interfaces - Middleware, Endpoint and Route."),Object(i.b)("p",null,"This interface defines 4 functions:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"Init() error")," - This is called to initialize the plugin. If an error is returned then the plugin will not be added to the backend.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"GetMiddlewarePlugin() (MiddlewarePlugin, error)")," - Provides the middleware that this plugin wishes to add to Stratos, if any. Return an error if your plugin does not need to add middleware.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"GetEndpointPlugin() (EndpointPlugin, error)")," - Provides the endpoint that this plugin wishes to add to Stratos, if any. Return an error if your plugin does not need to add middleware.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"GetRoutePlugin() (RoutePlugin, error)")," - Provides the route that this plugin wishes to add to Stratos, if any. Return an error if your plugin does not need to add middleware."))),Object(i.b)("p",null,"Each of the three plugin interfaces are described below."),Object(i.b)("h3",{id:"middleware"},"Middleware"),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"MiddlewarePlugin")," interface provides a plugin with a mechanism to add custom middleware to the Jetstream web server (Echo). This allows it to add upfront processing/filtering/handling of all API requests to the backend. There are two handlers that are required to be provided:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"EchoMiddleware")," - This is added as middleware to the echo web server for all requests that are not guarded by the session gate - i.e. requests that a non-logged-in user can access")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"SessionEchoMiddleware "),"- This is added as middleware to the echo web server for all requests that are  guarded by the session gate - i.e. requests that only a logged-in user can access"))),Object(i.b)("p",null,"This interface is defined in the file ",Object(i.b)("inlineCode",{parentName:"p"},"src/jetstream/repository/interfaces/general.go"),":"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-golang"}),"type MiddlewarePlugin interface {\n    EchoMiddleware(middleware echo.HandlerFunc) echo.HandlerFunc\n    SessionEchoMiddleware(middleware echo.HandlerFunc) echo.HandlerFunc\n}\n")),Object(i.b)("h3",{id:"endpoint"},"Endpoint"),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"EndpointPlugin")," should be used when a plugin wishes to add a new type of Endpoint. An example of this is the Metrics plugin in the folder ",Object(i.b)("inlineCode",{parentName:"p"},"src/jetstream/plugins/metrics"),"."),Object(i.b)("p",null,"This interface is defined in the file ",Object(i.b)("inlineCode",{parentName:"p"},"src/jetstream/repository/interfaces/endpoints.go"),":"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-golang"}),"type EndpointPlugin interface {\n    Info(apiEndpoint string, skipSSLValidation bool) (CNSIRecord, interface{}, error)\n    GetType() string\n    Register(echoContext echo.Context) error\n    Connect(echoContext echo.Context, cnsiRecord CNSIRecord, userId string) (*TokenRecord, bool, error)\n    UpdateMetadata(info *Info, userGUID string, echoContext echo.Context)\n}\n")),Object(i.b)("p",null,"Adding a new Endpoint type is more involved than other plugin types and will be documented in more detail later."),Object(i.b)("p",null,"For now, briefly:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"GetType"),' is used to return the endpoint type - a unique ID for the endpoint type - e.g. "metrics"'),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"Info")," is used to obtain information for the given endpoint URL"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"Register")," is called when the user wants to register a new Endpoint of this type"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"Connect")," is called when the user wants to connect a new Endpoint of this type"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"UpdateMetadata")," is called when the ",Object(i.b)("inlineCode",{parentName:"li"},"info")," request is made to the backend and gives each endpoint plugin the opportunity to update the metadata returned. For example, in the case of metrics, the plugin will update endpoints to indicate which have metrics metadata available.")),Object(i.b)("h3",{id:"routes"},"Routes"),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"RoutePlugin")," interface provides a plugin with a mechanism to add custom handlers to the Jetstream web server (Echo). This allows it to add any custom API processing. There are two handlers that are required to be provided:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"AddSessionGroupRoutes")," - This is added as a handler to the echo web server and is guarded so that only logged-in users can access.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"AddAdminGroupRoutes "),"- This is added as a handler to the echo web server and is guarded so that only logged-in users who are Stratos Administrators can access."))),Object(i.b)("p",null,"This interface is defined in the file ",Object(i.b)("inlineCode",{parentName:"p"},"src/jetstream/repository/interfaces/endpoints.go"),":"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-golang"}),"type RoutePlugin interface {\n    AddSessionGroupRoutes(echoContext *echo.Group)\n    AddAdminGroupRoutes(echoContext *echo.Group)\n}\n")),Object(i.b)("p",null,"The primary purpose of the RoutePlugin is to add new APIs to Jetstream."),Object(i.b)("p",null,"All handlers are added under the ",Object(i.b)("inlineCode",{parentName:"p"},"/v1")," URL prefix."))}s.isMDXComponent=!0},145:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var d=a.a.createContext({}),s=function(e){var t=a.a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=s(e.components);return a.a.createElement(d.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},u=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,d=c(e,["components","mdxType","originalType","parentName"]),p=s(n),u=r,m=p["".concat(o,".").concat(u)]||p[u]||b[u]||i;return n?a.a.createElement(m,l(l({ref:t},d),{},{components:n})):a.a.createElement(m,l({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=n[d];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);